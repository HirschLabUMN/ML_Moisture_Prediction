---
title: "NIR_PLS_Moisture_CompNum"
author: "Michael Burns"
date: "1/6/2020"
output: html_document
---

Loading required packages
```{r packages}
library(pls)
library(dplyr)
library(foreach)
library(doParallel)
library(beepr)
library(GauPro)
```

Loading the dataset
```{r loading_data}
trait_spec_data<-read_xlsx("../Data/Spectra_Data/spectra_learning_sets.xlsx")
moisture_spec_data <- trait_spec_data[,c(1:2,165,24:164)]
head(moisture_spec_data)
```


This function has been adapted from the function used in the NIR_Trait_Equations.Rmd file.  
```{r metrics_function}
dataset <- moisture_spec_data
column_of_interest <- 3
p <- 0.9
validation <- "CV"
ncomp <- 15


Moisture_Prediction_Metric_Function<-function(dataset,column_of_interest = 3, p = 0.90, metric = "RMSE", validation = "CV", ncomp = 15){

  #####
  # Loading dataset and partitioning
  #####
  trait_spec_data<-dataset
  trait_spec_data_index<-caret::createDataPartition(trait_spec_data[[column_of_interest]], p=p, list = FALSE)
  trait_spec_data_test<-as.data.frame(trait_spec_data[-trait_spec_data_index,])
  trait_spec_data_train<-as.data.frame(trait_spec_data[trait_spec_data_index,])
  
  #####
  # Creating spectra matrices
  #####
  training_spectra_readings<-as.matrix(trait_spec_data_train[,c(4:144)]) #having the spectra in a matrix will allow a cleaner code when calling them as predictors.
  dim(training_spectra_readings)
  test_spectra_readings<-as.matrix(trait_spec_data_test[,c(4:144)]) #having the spectra in a matrix will allow a cleaner code when calling them as predictors.
  dim(test_spectra_readings)
  
  #####
  # Creating the model
  #####
  spectra_model<-plsr(trait_spec_data_train[[column_of_interest]]~training_spectra_readings, validation = validation)
  
  #####
  # Prediction model
  #####
  component_predictions_pls<-drop(predict(spectra_model, ncomp = ncomp, newdata = test_spectra_readings))
  #component_predictions_pls_transformed<-component_predictions_pls
  
  #####
  # Which metric to print
  #####
  if(metric == "RMSE"){
  sqrt(mean((trait_spec_data_test[,column_of_interest]-component_predictions_pls)^2))
  }
    else{
      if(metric == "R2"){
        caret::R2(component_predictions_pls, trait_spec_data_test[,column_of_interest])
      }
        else{print("Unsupported metric, choose either RMSE or R2")}
    }
}
```

Looking at the effect of the number of components RMSE
```{r effect_of_ncomp_on_rmse}
registerDoParallel(cores = 5)
  RMSE_mean_data_c <- foreach(c = 1:25, .combine = c) %dopar%{
    mean(replicate(50,Moisture_Prediction_Metric_Function(moisture_spec_data, ncomp = c, metric = "RMSE")))
  }
  
RMSE_mean_data_c
plot(RMSE_mean_data_c, main = "Average RMSE of 50 trials at various ncomp values", ylab = "Average RMSE", xlab = "Ncomp Value")
#for foreach help, see: https://cran.r-project.org/web/packages/foreach/vignettes/foreach.pdf
```

Looking at the effect of the number of components R^2
```{r effect_of_ncomp_on_r2}
registerDoParallel(cores = 5)
  R2_mean_data_c <- foreach(c = 1:25, .combine = c) %dopar%{
    mean(replicate(50,Moisture_Prediction_Metric_Function(moisture_spec_data, ncomp = c, metric = "R2")))
  }
  
R2_mean_data_c
plot(R2_mean_data_c, main = "Average R^2 of 50 trials at various ncomp values", ylab = "Average R^2", xlab = "Ncomp Value")
#for foreach help, see: https://cran.r-project.org/web/packages/foreach/vignettes/foreach.pdf
```

```{r bootstrapping_model_rmse, cache = TRUE}
model_rmse_results <- vector(length = 1000)
pb <- progress_bar$new(total = 1000)
for(i in 1:1000){
  model_rmse_results[i] <- Moisture_Prediction_Metric_Function(moisture_spec_data)
  pb$tick()
}

sink(file = "../Spectra/Results/PLS_Bootstrap_RMSE.txt")
cat("\nMean:\n", mean(model_rmse_results),"\n")
cat("\nMedian:\n", median(model_rmse_results), "\n")
cat("\nStandard Deviation:\n", sd(model_rmse_results), "\n")
sink()
closeAllConnections()
png(filename = "../Spectra/Results/PLS_Bootstrap_RMSE.png")
boxplot(model_rmse_results)
dev.off()
```

```{r bootstrapping_model_r2, cache = TRUE}
model_r2_results <- vector(length = 1000)
pb <- progress_bar$new(total = 1000)
for(i in 1:1000){
  model_r2_results[i] <- Moisture_Prediction_Metric_Function(moisture_spec_data, metric = "R2")
  pb$tick()
}

sink(file = "../Spectra/Results/PLS_Bootstrap_R2.txt")
cat("\nMean:\n", mean(model_r2_results),"\n")
cat("\nMedian:\n", median(model_r2_results), "\n")
cat("\nStandard Deviation:\n", sd(model_r2_results), "\n")
sink()
closeAllConnections()
png(filename = "../Spectra/Results/PLS_Bootstrap_R2.png")
boxplot(model_r2_results)
dev.off()
```



Use coef.mvr to get the coefficients used in the pls model.




