---
title: "Moisture Uptake Data Analysis"
author: "Michael Burns"
date: "3/12/2020"
output: html_document
---

This R markdown file is to create a linear model of the moisture uptake data and determine the amount of variance explained by cooking parameters, macro trait estimations and spectral data. We will also look at correlations between moisture uptake and different macro traits, cooking parameters, and spectral values.

___
# Loading Data
___
```{r loading_data}
n400_dataset <- read_csv("../Data/Moisture_Uptake_Master_Dataset_Cook_Macro_Spectra.csv")
n5000_dataset <- read_csv("../Data/N5000_Master_With_Predictions.csv")
```

___
# Macro Trait ANOVA
___
```{r macro_trait_anova}
library(lme4)
library(magrittr)

trait_lmer <- n5000_dataset %$%
  lmer(Protein_As_is ~ (1 | Genotype) + (1 | Env/Rep) + (1 | Rep/Block) + (1 | Genotype:Env), REML = T) # (1|Env) is left out of the equation since the nesting with rep variable accounts for env.  If you add env itself to the equation, ranova wont work since there are technically two environments. After comparing with and without env models, the addition of env only accounts for 0.000012 units of stdev.

library(lattice)
library(lmerTest)


trait_var_source <- tibble(NULL)

for(i in c(6:10,152,153)){
  trait_lmer <- lmer(n5000_dataset[[i]] ~ (1 | Genotype) + (1 | Env/Rep) + (1 | Rep/Block) + (1 | Genotype:Env), data = n5000_dataset, REML = T)
  
  var_source <- tidy(ranova(trait_lmer)) %>%
    select(term, p.value) %>%
    filter(term != "<none>") %>%
    mutate(term = str_remove_all(string = term, pattern = "[(,1, ,|,)]")) %>%
    rename(Parameter = term)
  
  var_exp <- summary(trait_lmer)[[13]] %>%
    as_data_frame() %>%
    select(grp, sdcor) %>%
    rename(Parameter = grp, 
          StDev = sdcor) %>%
    mutate(var = StDev^2,
           total_var = sum(var),
           Percent_Var = (var/total_var) * 100) %>%
    select(Parameter, Percent_Var) %>%
    full_join(var_source) %>%
    mutate(Trait = colnames(n5000_dataset[i]))
  
  trait_var_source <- bind_rows(trait_var_source, var_exp)
}
```

```{r}
trait_var_source %>%
  mutate(Parameter = fct_relevel(Parameter, c("Genotype", "Env", "Genotype:Env", 
                                              "Rep:Env", "Rep", "Block:Rep", 
                                              "Residual")),
         Trait = fct_relevel(Trait, c('LM_Prediction', 'SVML_Prediction', 'Ash_As_is', 
                                      'Fat_As_is', 'Fiber_As_is', "Starch_As_is", 
                                      'Protein_As_is'))) %>%
  ggplot(aes(x = Trait, y = Percent_Var))+
  geom_bar(stat = "identity")+
  coord_flip()+
  ylim(0,100)+
  labs(x = "Macromolecular Trait",
       y = "Percent Variance Explained",
       title = "Macromolecular Variance Explained by Source")+
  facet_grid(~Parameter, labeller = labeller(Parameter = c(Genotype = "Genotype", 
                                                           Env = "Environment", 
                                                           `Genotype:Env` = "GxE", 
                                                           `Rep:Env` = "Rep/Env", 
                                                           Rep = "Rep", 
                                                           `Block:Rep` = "Block/Rep",
                                                           Residual = "Residual")))+
  theme_bw()+
  scale_x_discrete(labels = c("LM Prediction", "SVML Prediction", 'Ash', 'Fat', 'Fiber',
                              'Starch', 'Protein'))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r spectra_trait_anova}
library(lme4)
library(magrittr)

tibble(NULL)

registerDoParallel(cores = 4)
spectra_var_source <- foreach(i = 11:151, .combine = rbind) %dopar% {
  trait_lmer <- lmer(n5000_dataset[[i]] ~ (1 | Genotype) + (1 | Env/Rep) + 
                       (1 | Rep/Block) + (1 | Genotype:Env), data = n5000_dataset, 
                     REML = T)
  
  var_source <- tidy(ranova(trait_lmer)) %>%
    select(term, p.value) %>%
    filter(term != "<none>") %>%
    mutate(term = str_remove_all(string = term, pattern = "[(,1, ,|,)]")) %>%
    rename(Parameter = term)
  
  var_exp <- summary(trait_lmer)[[13]] %>%
    as_data_frame() %>%
    select(grp, sdcor) %>%
    rename(Parameter = grp, 
          StDev = sdcor) %>%
    mutate(var = StDev^2,
           total_var = sum(var),
           Percent_Var = (var/total_var) * 100) %>%
    select(Parameter, Percent_Var) %>%
    full_join(var_source) %>%
    mutate(Trait = colnames(n5000_dataset[i]))
  
  return(list(
    Parameter = var_exp$Parameter,
    Percent_Variance = var_exp$Percent_Var,
    Trait = var_exp$Trait
  ))
}

spectra_var_source
```

```{r}
spectra_var_source %>%
  as_tibble() %>%
  unnest(cols = c(Parameter, Percent_Variance, Trait)) %>%
  mutate(Parameter = fct_relevel(Parameter, c("Genotype", "Env", "Genotype:Env", 
                                              "Rep:Env", "Rep", "Block:Rep", 
                                              "Residual"))) %>%
  ggplot(aes(x = as.numeric(Trait), y = Percent_Variance))+
  geom_area()+
  ylim(0,100)+
  #scale_y_continuous(breaks = c(0,50,100))+
  labs(x = "Waveband",
       y = "Percent Variance Explained",
       title = "Waveband Absorbance Variance Explained by Source")+
  facet_wrap(~Parameter, ncol = 1, labeller = labeller(Parameter = c(Genotype = "Genotype", 
                                                           Env = "Environment", 
                                                           `Genotype:Env` = "GxE", 
                                                           `Rep:Env` = "Rep/Env", 
                                                           Rep = "Rep", 
                                                           `Block:Rep` = "Block/Rep",
                                                           Residual = "Residual")))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text())
```

```{r}
seq(950,1650,5)
```

___
# Variance Explained
___
For ease of use, the spectral data will need to be cut off into its own matrix.  Lets try to do this for each section of the data (sepctra, traits, and cooking parameters)
```{r}
spectra_data <- as.matrix(n400_dataset[c(27:167)])
trait_data <- as.matrix(n400_dataset[c(9:25)])
cooking_data <- as.matrix(n400_dataset[c(6:8)])
```

Now lets create a linear model that we can create an anova table from:
```{r}
library(car)
mup_lm <- lm(n400_dataset$Moisture_Uptake ~ spectra_data + trait_data + cooking_data)
Anova(mup_lm, type = "II")
Anova(mup_lm)["spectra_data","Sum Sq"]
broom::tidy(Anova(mup_lm, type = "II"))
```

Above are methods I can use to extract the values of interest.  I think the way I am going to use them is with the tidy function.
```{r}
library(car)
mup_anova_table <- broom::tidy(Anova(mup_lm, type = "II"))
mup_anova_table %>%
  mutate(Total_SS = sum(sumsq),
         `R^2` = sumsq/Total_SS,
         `Data Type` = c("Spectra", "Macro Trait", "Cooking", "Residual")) %>% 
  select(c(`Data Type`, `R^2`))
```
___
# Correlations
___
```{r}
mup_cors <- cor(n400_dataset %>% 
      mutate(Env = as.factor(Env),
             Block = as.factor(Block),
             Rep = as.factor(Rep)) %>%
      select_if(is.numeric)) %>%
  as_tibble() %>%
  mutate(Variable = colnames(.)) %>%
  pivot_longer(cols = -Variable, names_to = "Variable_2", values_to = "Correlation") %>%
  mutate(crit_t = qt(p = 0.05/2, df = 313, lower.tail = F),
         t_val = abs((Correlation) / (sqrt((1 - (Correlation^2)) / 313)))) %>%
  filter(Correlation != 1) %>%
  filter(Variable == "Moisture_Uptake") %>%
  filter(t_val > crit_t) %>%
  arrange(desc(t_val)) 
```
There are many significantly correlated traits.  All spectral bands seem to be significantly negatively correlated with moisutre uptake, and a few macro traits are as well.  No cooking parameters appear to be significantly correlated.

```{r}
mup_cors %>%
  mutate(data_type = case_when(str_detect(string = Variable_2, 
                                          pattern = "[0-9]") ~ "Spectra",
                               str_detect(string = Variable_2, 
                                          pattern = "[a-z]") ~ "Macro")) %>%
  select(Correlation, data_type) %>%
  rename(`Data Type` = data_type) %>%
  group_by(`Data Type`) %>%
  summarise(`Mean Abs Val Corr` = mean(abs(Correlation)),
            `St Dev Abs Val Corr` = sd(abs(Correlation)))
```






